language: python
python:
  - "2.6"
  - "2.7"

env:
  global:
  - secure: e7ZCh4g6NsmO/xjJvwF1Zx33jXhsilqKG86bjlfVbhtKMh4M9JxlomZvdhsbmv2n8jpPNCUa8yqSWjDxKBB9VHjTsABgVb48XTBivfRzWy750idSsH7RWz8kdnGzQpLPBw43xM81oO0LPaetFIk1+eV+gT6iBk/GJpfEZu3cMAU=  # DOCKER_USER
  - secure: infy+LeJ3JWUo414hp58RTpjDsDXXPrtkjniaX7RguY1h3o7ewMQlAuVDh2/rAisGJXnwWSX0NrAGvr4X8nzcBKR09Rw/5M+T1ORi9jN+orxuHFCA5+XHpfbLvRiSnjUZqcQv2t3mPWsUMnlwMaAqVjZW0/7uS9fMlGw7cYzMaw=  # DOCKER_EMAIL
  - secure: c2ImpLoN/71+uZ1JAA06ENPYWon9Ohrq0HoKBhZ+6nyYiIl1BznPraWmQZOkx/rgg9IOBM4BMIdfOFhimrI6LDV2m5XlIpSct77wM/qVJyZi6TNuoS6zmRUfcJ9Rm3oAzRhv17Z0gvX1jTlKtlLJXPPyaLjlBAG8OAo7/aklqRk=  # DOCKER_PASS

install:
  - "pip install --upgrade 'setuptools' 'pip>=8.1.2'"
  - "pip install 'pytest>=2.10' 'pytest-cov' 'mock' 'tox'"
  - "pip install ."

script:
  - py.test --cov=elasticluster
sudo: false

after_success:
  - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
  - export BRANCH=$(echo "${TRAVIS_PULL_REQUEST_BRANCH:-$TRAVIS_BRANCH}" | cut -c-8)
  - export COMMIT=$(echo "${TRAVIS_PULL_REQUEST_SHA:-$TRAVIS_COMMIT}" | cut -c-8)
  - export TAG=$(if [ "$TRAVIS_PULL_REQUEST" = 'false']; then echo "pr#$TRAVIS_PULL_REQUEST"; else if [ "$BRANCH" = "master" ]; then echo "latest"; else echo "$BRANCH" ; fi)
  - docker build -f Dockerfile -t $TRAVIS_REPO_SLUG:$COMMIT .
  - docker tag $TRAVIS_REPO_SLUG:$COMMIT $TRAVIS_REPO_SLUG:$TAG
  - docker tag $TRAVIS_REPO_SLUG:$COMMIT $TRAVIS_REPO_SLUG:travis-$TRAVIS_BUILD_NUMBER
  - docker push $TRAVIS_REPO_SLUG
