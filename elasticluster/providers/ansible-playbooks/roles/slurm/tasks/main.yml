---
- name: Install required SLURM packages (Debian/Ubuntu)
  action: apt pkg={{item}} update_cache=yes force=yes state=latest
  with_items:
    - slurm-llnl
    - munge
  when: is_debian_or_ubuntu

- name: Install required SLURM packages (CentOS 6)
  yum: name={{item}} state=latest
  with_items:
    - munge
    - munge-devel
    - pam-devel
    - readline-devel
    - openssl-devel
    - perl-ExtUtils-MakeMaker
    - perl-DBI
    - rpm-build
    - gcc
    - mysql-devel
  when: is_centos_6

- name: Install required SLURM packages (CentOS 7)
  action: copy src=etc/yum.repos.d/copr-slurm.repo dest=/etc/yum.repos.d/copr-slurm.repo owner=root
  when: is_centos_7

- name: Download SLURM source package (CentOS 6)
  get_url: url={{slurm_src_baseurl}}/{{slurm_src_filename}} dest=/tmp/{{slurm_src_filename}}
  when: is_centos_6

- name: Recomiple SLURM source package (CentOS 6)
  shell: rpmbuild -ta /tmp/{{slurm_src_filename}} creates=/root/rpmbuild/RPMS/x86_64/{{slurm_pkg_name}}
  when: is_centos_6

- name: Install SLURM packages (CentOS 6)
  yum: name={{item}} state=present
  with_items:
    - /root/rpmbuild/RPMS/x86_64/slurm-15.08.9-1.el6.centos.x86_64.rpm
    - /root/rpmbuild/RPMS/x86_64/slurm-devel-15.08.9-1.el6.centos.x86_64.rpm
    - /root/rpmbuild/RPMS/x86_64/slurm-munge-15.08.9-1.el6.centos.x86_64.rpm
    - /root/rpmbuild/RPMS/x86_64/slurm-pam_slurm-15.08.9-1.el6.centos.x86_64.rpm
    - /root/rpmbuild/RPMS/x86_64/slurm-perlapi-15.08.9-1.el6.centos.x86_64.rpm
    - /root/rpmbuild/RPMS/x86_64/slurm-plugins-15.08.9-1.el6.centos.x86_64.rpm
    - /root/rpmbuild/RPMS/x86_64/slurm-sjobexit-15.08.9-1.el6.centos.x86_64.rpm
    - /root/rpmbuild/RPMS/x86_64/slurm-sjstat-15.08.9-1.el6.centos.x86_64.rpm
    - /root/rpmbuild/RPMS/x86_64/slurm-slurmdbd-15.08.9-1.el6.centos.x86_64.rpm
    - /root/rpmbuild/RPMS/x86_64/slurm-slurmdb-direct-15.08.9-1.el6.centos.x86_64.rpm
    - /root/rpmbuild/RPMS/x86_64/slurm-sql-15.08.9-1.el6.centos.x86_64.rpm
    - /root/rpmbuild/RPMS/x86_64/slurm-torque-15.08.9-1.el6.centos.x86_64.rpm
  when: is_centos_6

- name: Install SLURM packages (CentOS 7)
  yum: name={{item}} state=present
  with_items:
    - slurm
    - slurm-devel
    - slurm-munge
    - slurm-pam_slurm
    - slurm-perlapi
    - slurm-plugins
    - slurm-sjobexit
    - slurm-sjstat
    - slurm-slurmdbd
    - slurm-slurmdbd-direct
    - slurm-sql
    - slurm-torque
  when: is_centos_7


- name: Create slurm user (CentOS)
  user: name=slurm system=yes
  when: is_centos

- include: slurm.yml
- include: munge.yml
