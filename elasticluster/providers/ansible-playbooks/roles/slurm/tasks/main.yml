---
- name: Install required SLURM packages (Debain/Ubuntu)
  action: apt pkg={{item}} update_cache=yes force=yes state=latest
  with_items:
    - slurm-llnl
    - munge
  when: is_debian_or_ubuntu

- name: Install required SLURM packages (CentOS)
  yum: name={{item}} state=latest
  with_items:
    - munge
    - munge-devel
    - pam-devel
    - readline-devel
    - openssl-devel
    - perl-ExtUtils-MakeMaker
    - perl-DBI
    - rpm-build
    - gcc
    - mysql-devel
  when: is_centos

- name: Download SLURM source package (CentOS)
  get_url: url={{slurm_src_baseurl}}/{{slurm_src_filename}} dest=/tmp/{{slurm_src_filename}}
  when: is_centos

- name: Recomiple SLURM source package (CentOS)
  shell: rpmbuild -ta /tmp/{{slurm_src_filename}} creates=/root/rpmbuild/RPMS/x86_64/{{slurm_pkg_name}}
  when: is_centos

- name: Install SLURM packages (CentOS)
  yum: name={{item}} state=present
  with_items:
    - /root/rpmbuild/RPMS/x86_64/slurm-15.08.4-1.el7.centos.x86_64.rpm
    - /root/rpmbuild/RPMS/x86_64/slurm-devel-15.08.4-1.el7.centos.x86_64.rpm
    - /root/rpmbuild/RPMS/x86_64/slurm-munge-15.08.4-1.el7.centos.x86_64.rpm
    - /root/rpmbuild/RPMS/x86_64/slurm-pam_slurm-15.08.4-1.el7.centos.x86_64.rpm
    - /root/rpmbuild/RPMS/x86_64/slurm-perlapi-15.08.4-1.el7.centos.x86_64.rpm
    - /root/rpmbuild/RPMS/x86_64/slurm-plugins-15.08.4-1.el7.centos.x86_64.rpm
    - /root/rpmbuild/RPMS/x86_64/slurm-sjobexit-15.08.4-1.el7.centos.x86_64.rpm
    - /root/rpmbuild/RPMS/x86_64/slurm-sjstat-15.08.4-1.el7.centos.x86_64.rpm
    - /root/rpmbuild/RPMS/x86_64/slurm-slurmdbd-15.08.4-1.el7.centos.x86_64.rpm
    - /root/rpmbuild/RPMS/x86_64/slurm-slurmdb-direct-15.08.4-1.el7.centos.x86_64.rpm
    - /root/rpmbuild/RPMS/x86_64/slurm-sql-15.08.4-1.el7.centos.x86_64.rpm
    - /root/rpmbuild/RPMS/x86_64/slurm-torque-15.08.4-1.el7.centos.x86_64.rpm
  when: is_centos

- name: Create slurm user (CentOS)
  user: name=slurm system=yes
  when: is_centos

- include: slurm.yml
- include: munge.yml
