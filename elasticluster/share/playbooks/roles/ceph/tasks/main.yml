---

- name: Check that at least one MON node is configured
  tags:
    - ceph
  fail:
    msg: 'At least one node should be in the `ceph_mon` group!'
  when: 'groups.ceph_mon|length|int < 1'


- name: Check that at least two OSD nodes are configured
  tags:
    - ceph
  fail:
    msg: 'At least two nodes should be in the `ceph_osd` group!'
  when: 'groups.ceph_osd|length|int < 2'


- name: Run distribution-specific setup
  tags:
    - ceph
  include: 'init-{{ansible_os_family}}.yml'


- name: Does user `ceph` exist?
  tags:
    - ceph
  command: |
    getent passwd ceph
  register: check_user_ceph_existence
  ignore_errors: yes


- name: Create user `ceph` if needed
  tags:
    - ceph
  user:
    name: ceph
    home: /var/lib/ceph
    system: yes
    state: present
  when: check_user_ceph_existence|failed


- name: Ensure working directories exist
  tags:
    - ceph
  file:
    dest: '{{item}}'
    state: directory
  with_items:
    - '/etc/ceph'
    - '/var/run/ceph'


- name: Deploy Ceph configuration file
  template:
    src: etc/ceph/ceph.conf.j2
    dest: /etc/ceph/ceph.conf
    mode: 0444
  tags:
    - ceph


- name: Gather Ceph facts
  tags:
    - ceph
    - facts
  action: ceph_facts


- name: Create master files on primary MON node
  tags:
    - ceph
  include: '{{playbook}}.yml'
  with_items:
    - _keyring
    - _monmap
  loop_control:
    loop_var: playbook
  when: 'inventory_hostname == groups.ceph_mon[0]'


- name: Copy master files to all nodes
  tags:
    - ceph
  copy:
    src: '/tmp/{{item}}'
    dest: '/etc/ceph/{{item}}'
    owner: ceph
    group: ceph
    mode: 0600
  with_items:
    - '{{ceph_cluster_name}}.keyring'
    - monmap


- name: Install MON nodes
  tags:
    - ceph
  include: mon.yml
  when: 'inventory_hostname in groups.ceph_mon'


- name: Install MGR nodes
  tags:
    - ceph
  include: mgr.yml
  when: '{{ceph_requires_mgr}} and (inventory_hostname in groups.ceph_mon)'


- name: Install OSD nodes
  tags:
    - ceph
  include: osd.yml
  when: 'inventory_hostname in groups.ceph_osd'


- name: Install MDS nodes
  tags:
    - ceph
  include: mds.yml
  when: 'inventory_hostname in groups.ceph_mds|default([])'


- name: Create filesystem
  tags:
    - ceph
    - cephfs
  include: fs.yml
  # use client.admin key from mon0 host
  when: 'groups.ceph_mds|default([])|length > 0 and inventory_hostname in groups.ceph_mon'
