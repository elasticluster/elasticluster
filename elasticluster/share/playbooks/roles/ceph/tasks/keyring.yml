---
#
# Create CephX authentication keys.  Should be run on the *first* MON node only.
#


- name: Does the keyring exist?
  stat:
    path: '/etc/ceph/ceph.keyring'
  register: ceph_keyring_file
  ignore_errors: yes


- name: Create Ceph keyring
  command: |
    ceph-authtool --create-keyring /etc/ceph/ceph.keyring
  when: 'not ceph_keyring_file.stat.exists'


- name: Create MON and ADMIN keys if not existing
  include: _auth.yml
  vars:
    keyname: '{{item.keyname}}'
    varname: '{{item.varname}}'
    capabilities: '{{item.capabilities}}'
  with_items:
    - keyname: 'mon.'
      varname: 'mon'
      capabilities: '--cap mon "allow *"'
    - keyname: 'client.admin'
      varname: 'client_admin'
      capabilities: '--cap mon "allow *" --cap osd "allow *" --cap mds "allow *" {% if ceph_requires_mgr %}--cap mgr "allow *"{% endif %}'


# grab a copy of the keyring so we can later deploy it on all Ceph nodes
# (the other half, i.e. copy *to* all, cannot be done here as this
# playbook only runs on the first MON node)
- name: Fetch master keyring file
  fetch:
    src: /etc/ceph/ceph.keyring
    dest: /tmp/ceph.keyring
    flat: yes
