---

- name: Restart SLURMcltd
  hosts: slurm_master
  tasks:
    - service:
        name: slurmctld
        state: restarted
      when: 'is_debian_compatible and (is_debian_8_or_later or is_ubuntu_15_10_or_later)'
    - service:
        name: slurmctl-llnl
        state: restarted
      when: 'is_debian_compatible and not (is_debian_8_or_later or is_ubuntu_15_10_or_later)'
    - service:
        name: slurmctld
        state: restarted
      when: is_rhel7_compatible
    - service:
        name: slurmctl
        state: restarted
      when: is_rhel6_compatible

- name: Restart SLURMd
  hosts: slurm_worker
  tasks:
    - name: Create pidfile directory to deal with slurm restart bug.
      file:
        path: /var/run/slurm-llnl
        state: directory
      when: 'is_debian_compatible and (is_debian_8_or_later or is_ubuntu_15_10_or_later)'

    - name: Get running slurm processes
      shell: "ps -ef | grep -v grep | grep -w slurmd | awk '{print $2}'"
      register: running_slurm
      when: 'is_debian_compatible and (is_debian_8_or_later or is_ubuntu_15_10_or_later)'
    - name: Kill running slurm processes
      shell: "kill -9 {{ item }}"
      with_items: "{{ running_slurm.stdout_lines }}"
      when: 'is_debian_compatible and (is_debian_8_or_later or is_ubuntu_15_10_or_later)'

    - systemd:
        name: slurmd
        state: started
      when: 'is_debian_compatible and (is_debian_8_or_later or is_ubuntu_15_10_or_later)'
    - service:
        name: slurm-llnl
        state: restarted
      when: 'is_debian_compatible and not (is_debian_8_or_later or is_ubuntu_15_10_or_later)'
    - service:
        name: slurmd
        state: restarted
      when: is_rhel7_compatible
    - service:
        name: slurm
        state: restarted
      when: is_rhel6_compatible
