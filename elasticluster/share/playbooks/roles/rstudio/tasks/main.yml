---


- name: Check playbook compatibility with host platform
  fail:
    msg="R Studio Server installation only works on Debian/Ubuntu presently."
  when: not is_debian_compatible


- name: create download directory
  file:
    path: "r-studio-server"
    state: directory
    owner: root
    group: root
    mode: 0755


- name: download R Studio Server package
  command: >
    curl -sSL
    https://download2.rstudio.org/rstudio-server-{{ rstudio_server_version }}-amd64.deb
    -o /tmp/r-studio-server/{{ rstudio_server_version }}_amd64.deb
  args:
    creates: "/tmp/r-studio-server/{{ rstudio_server_version }}_amd64.deb"


- name: install R Studio Server
  apt:
    deb: "/tmp/r-studio-server/{{ rstudio_server_version }}_amd64.deb"


- name: update server configuration file
  template:
    src: etc/rstudio/rserver.conf.j2
    dest: /etc/rstudio/rserver.conf
    owner: root
    group: root
    mode: 0444


- name: update session configuration file
  template:
    src: etc/rstudio/rsession.conf.j2
    dest: /etc/rstudio/rsession.conf
    owner: root
    group: root
    mode: 0444


- name: add default user with password
  user:
    name: "{{ rstudio_default_user }}"
    password: "{{ rstudio_default_pass | password_hash('sha512') }}"
    comment: "R Studio web user"


- service:
    name: rstudio-server
    state: restarted
