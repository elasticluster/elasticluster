# Install and configure the MUNGE authentication service
---

- block:
  - name: Mask MUNGE from starting on install
    command: systemctl mask munge.service creates=/etc/systemd/system/munge.service
    when: ansible_service_mgr == 'systemd'
  - name: Install MUNGE (Debian/Ubuntu)
    package:
      pkg=munge
      state=latest
  - name: Unmask MUNGE from starting on install
    command: systemctl unmask munge.service && systemctl daemon-reload removes=/etc/systemd/system/munge.service
    when: ansible_service_mgr == 'systemd'
  - name:  Reload systemd
    command: systemctl daemon-reload
    when: ansible_service_mgr == 'systemd'
  tags:
    - slurm
    - munge
    - debian
  when: is_debian_compatible


- name: Install MUNGE (RHEL-compatible)
  tags:
    - slurm
    - munge
    - rhel
  package:
    pkg=slurm-munge
    state=latest
  when:
    is_rhel_compatible


- name: patch `/etc/default/munge` on Ubuntu 14.04
  tags:
    - slurm
    - munge
    - ubuntu
    - trusty
  lineinfile:
    dest='/etc/default/munge'
    line='OPTIONS="--force"'
    regexp='^OPTIONS='
    state=present
  when: is_ubuntu_trusty

- name: patch `/lib/systemd/system/munge.service` on Ubuntu >= 14.10
  tags:
    - slurm
    - munge
    - ubuntu
  lineinfile:
    dest='/lib/systemd/system/munge.service'
    line='ExecStart=/usr/sbin/munged --syslog'
    regexp='^ExecStart=/usr/sbin/munged'
    state=present
  when: is_ubuntu_14_10_or_later

- name: Configure MUNGE
  tags:
    - slurm
    - munge
  copy:
    src=etc/munge/munge.key
    dest=/etc/munge/munge.key
    owner=munge
    group=munge
    mode=0400
  notify: restart munge

  
- name: Ensure the MUNGE service is running
  tags:
    - slurm
    - munge
  service:
    name=munge
    enabled=yes
    state=started
