---
#
# Set up the package manager and its Ansible module for installing packages
#

- name: Ensure extra repositories are present (Ubuntu)
  apt_repository:
    repo="deb http://archive.ubuntu.com/ubuntu {{ansible_distribution_release}} universe multiverse"
    state=present
    mode=0444
  when: is_ubuntu

- name: Ensure the APT package cache is updated
  apt:
    update_cache=yes
    cache_valid_time=0

- name: Install Ansible `apt` module dependencies
  # the `apt` module depends on both `aptitude` and `python-apt` to do
  # package-level work, so we need to resort to a raw invocation of `apt-get`
  command: apt-get install -y aptitude python-apt
  become: yes

- name: Upgrade all installed packages to latest version
  apt:
    upgrade=safe

- name: Ensure additional packages are installed
  apt:
    name={{item}}
    state=present
  with_items:
    - apt-transport-https
    # these are required by Ansible's `debconf` module
    - debconf
    - debconf-utils

- name: Provide workaround for https://github.com/ansible/ansible-modules-core/issues/4472
  set_fact:
    __at__: '='

- block:
    - name: Install policy package for service autostart
      apt:
        name: 'policyrcd-script-zg2'
        state: present
    - name: Install policy script for service autostart
      copy:
        dest: '/etc/policy-rc.d'
        src: 'etc/policy-rc.d'
        mode: 0555
  when: 'not {{init_is_systemd}}'
