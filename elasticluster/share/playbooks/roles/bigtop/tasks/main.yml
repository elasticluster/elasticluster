# bigtop/tasks/main.yml
---
- name: Check playbook compatibility with host platform
  fail:
    msg="PySpark/Hadoop installation only works on Debian/Ubuntu presently."
  when: not is_debian_or_ubuntu

- name: download signing key for Apache Bigtop repository
  get_url:
    url: https://cloud.s3it.uzh.ch:8080/v1/AUTH_6169dd64a7ed498581cee5abff0c6cd7/bigtop/debs/bigtop.asc
    dest: /tmp/bigtop.asc

  # Ansible apt module cannot work with local files, and uri doesn't support https
- name: add signing key for Apache Bigtop repository
  command: sudo apt-key add /tmp/bigtop.asc
  
- name: add Apache Bigtop repository
  apt_repository:
    # download from: http://www.apache.org/dist/bigtop/bigtop-1.0.0/repos/trusty/bigtop.list
    repo='deb https://cloud.s3it.uzh.ch:8080/v1/AUTH_6169dd64a7ed498581cee5abff0c6cd7/bigtop/debs/{{ansible_distribution_release}} ./'
    state=present


# this is run as task and not as a handler, since handlers are all
# executed after *all* tasks in the play have run, and we need the
# package cache to be up-to-date immediately for subsequent install
# tasks to succeed...
- name: update APT cache
  apt:
    update_cache=yes
    cache_valid_time=86400
